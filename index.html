<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>异步寻宝 </title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#111827; --accent:#f6c453; --text:#eaf1ff;
    --muted:#9fb0cc; --danger:#ff5c7a; --success:#64d38a; --info:#5ec8ff;
    --border:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background: radial-gradient(1200px 600px at 70% 0%, #10182a, var(--bg)); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial}
  .wrap{max-width:1200px; margin:0 auto; padding:16px; display:grid; gap:16px; grid-template-columns: 1.3fr 1fr;}
  @media (max-width: 900px){ .wrap{grid-template-columns: 1fr;} }

  .stage{
    position:relative; min-height:480px; border-radius:14px; overflow:hidden;
    border:1px solid var(--border); background: linear-gradient(#0f1526 55%, #0b0f1a); box-shadow:0 10px 28px rgba(0,0,0,.35);
  }
  .sky{position:absolute; inset:0 0 55% 0; transition: background 1s ease;}
  .ground{position:absolute; inset:55% 0 0 0; background: repeating-linear-gradient(90deg, #0d1526 0 40px, #0a1120 40px 80px);}
  .fog{position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .8s; background:
    radial-gradient(60% 40% at 50% 30%, rgba(255,255,255,.05), transparent 60%),
    radial-gradient(40% 30% at 20% 20%, rgba(255,255,255,.05), transparent 60%),
    radial-gradient(50% 35% at 80% 25%, rgba(255,255,255,.05), transparent 60%);
    filter: blur(2px);
  }
  .rain{position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .6s;}
  .drop{position:absolute; width:2px; height:18px; background:linear-gradient(to bottom, rgba(255,255,255,.2), rgba(255,255,255,.0));
    animation: rain 0.8s linear infinite; }
  @keyframes rain { from{ transform: translateY(-20px)} to{ transform: translateY(120vh)} }

  .star{position:absolute; width:2px; height:2px; background:#fff; opacity:.8; border-radius:50%;}

  .hero{
    --x: 8%;
    position:absolute; bottom:18%; left:var(--x); width:48px; height:48px; border-radius:10px;
    background: linear-gradient(145deg, #3da1ff, #1a5fb4); display:grid; place-items:center;
    box-shadow: 0 6px 18px rgba(61,161,255,.35);
    transition: left .8s ease, transform .25s ease, filter .3s;
  }
  .hero::after{content:"🧭"; transform:translateX(2px)}
  .hero.happy{filter: saturate(1.3) brightness(1.1)}
  .hero.sad{filter: grayscale(.4) brightness(.9)}

  .cone{
    position:absolute; bottom:28%; left:calc(var(--x) + 26px);
    width:0; height:0; border-left: 140px solid rgba(246,196,83,.18);
    border-top: 40px solid transparent; border-bottom: 40px solid transparent;
    filter: blur(2px); transition:left .8s ease; pointer-events:none;
  }
  .spark{position:absolute; width:4px; height:4px; background:#f9d27a; border-radius:50%; opacity:.8; pointer-events:none;}
  .door{position:absolute; bottom:15%; left:40%; width:40px; height:88px; background: linear-gradient(#7a6a3a, #4a3e1e);
    border:2px solid #bfa15a; border-radius:6px; transform-origin:left center; transform: perspective(200px) rotateY(0deg); transition: transform .6s ease;}
  .door.open{ transform: perspective(200px) rotateY(-65deg); }
  .guard{position:absolute; bottom:18%; left:62%; width:46px; height:46px; border-radius:50%;
    background: linear-gradient(145deg, #e0586b, #7c1e2c); box-shadow: 0 6px 18px rgba(224,88,107,.35); display:grid; place-items:center; }
  .guard::after{content:"🛡️"}
  .patrol{ animation: patrol 4.4s ease-in-out infinite; }
  @keyframes patrol{ 0%{transform:translateX(-18px)} 50%{transform:translateX(18px)} 100%{transform:translateX(-18px)} }

  .chest{position:absolute; bottom:16%; left:80%; width:60px; height:40px; border-radius:6px; background: linear-gradient(#9c5324, #5a2e12);
    border:2px solid #d89a52; display:grid; place-items:center; }
  .chest::after{content:"📦"}
  .chest.glow{ box-shadow: 0 0 24px 8px rgba(246,196,83,.35) inset, 0 0 18px rgba(246,196,83,.4); }

  .panel{ background: var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; min-height:480px; box-shadow: 0 10px 28px rgba(0,0,0,.35); display:flex; flex-direction:column;}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .title{font-weight:800; font-size:18px; margin-bottom:8px}
  .log{flex:1; overflow:auto; padding:8px; background:rgba(10,16,30,.6); border-radius:8px; border:1px solid #1e2a44;
       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; line-height:1.4; color:var(--muted);}
  .log p{margin:.25rem 0}
  .log p.ok{color:var(--success)}
  .log p.err{color:var(--danger)}
  .log p.info{color:var(--info)}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  button, select{
    background:linear-gradient(180deg, #1a2b4b, #13213a); color:var(--text); border:1px solid #28416e; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600;
  }
  button:hover{filter:brightness(1.08)}
  button:disabled{opacity:.6; cursor:not-allowed}
  .progress{height:8px; background:#0e1a30; border:1px solid #1f2a44; border-radius:6px; overflow:hidden; margin-top:8px}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, #f6c453, #64d38a); transition:width .2s}

  .mini{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}
  .pill{border:1px solid #28416e; padding:4px 8px; border-radius:999px; background:#0f1b32}
  .toast{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#0f1b32; color:#730a0a; border:1px solid #28416e; padding:10px 14px; border-radius:8px; opacity:0; pointer-events:none; transition: opacity .3s, transform .3s;}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-8px)}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <div class="sky" id="sky"></div>
    <div class="ground"></div>
    <div class="fog" id="fog"></div>
    <div class="rain" id="rain"></div>
    <div id="stars"></div>

    <div class="hero" id="hero"></div>
    <div class="cone" id="cone"></div>
    <div class="door" id="door"></div>
    <div class="guard patrol" id="guard"></div>
    <div class="chest" id="chest"></div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="title">异步寻宝 </div>
      <div class="mini" id="envInfo"></div>
    </div>
    <div class="log" id="log"></div>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <div class="controls">
      <button id="run">开始寻宝</button>
      <button id="retry" disabled>重试</button>
      <select id="difficulty">
        <option value="easy">难度：简单</option>
        <option value="normal" selected>难度：普通</option>
        <option value="hard">难度：困难</option>
      </select>
      <select id="path">
        <option value="safe">路线：安全</option>
        <option value="risky">路线：捷径</option>
      </select>
      <button id="toggleRandom">关闭随机失败</button>
      <button id="exportLog">导出日志</button>
      <button id="onlyError">仅看错误：关</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">就绪</div>

<script>
// ================= 工具与状态 =================
const sleep = ms => new Promise(r=>setTimeout(r, ms));
const tip = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); };
const logBox = document.getElementById('log'); let logStore = []; let onlyErr=false;
function log(msg, type){
  logStore.push({msg, type, t:Date.now()});
  if(onlyErr && type!=='err') return;
  const p = document.createElement('p'); p.textContent = msg; if(type) p.classList.add(type); logBox.appendChild(p);
  logBox.scrollTop = logBox.scrollHeight;
}
function clearLog(){ logBox.innerHTML=''; logStore=[]; }
function exportLog(){
  const text = logStore.map(x=>`[${new Date(x.t).toLocaleTimeString()}][${x.type||'info'}] ${x.msg}`).join('\n');
  const blob = new Blob([text], {type:'text/plain'}); const a=document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'treasure-log.txt'; a.click(); URL.revokeObjectURL(a.href);
}
const withTimeout = (p, ms, label='操作') => Promise.race([p, new Promise((_, rej)=>setTimeout(()=>rej(new Error(`${label}超时(${ms}ms)`)), ms))]);
const retry = async (fn, times=1, delay=500, label='步骤')=>{
  let lastErr;
  for(let i=0;i<=times;i++){
    try{ return await fn(); }
    catch(e){ lastErr = e; log(`${label}失败：${e}`, 'err'); if(i<times){ log(`等待${delay}ms后重试...`,'info'); await sleep(delay);} }
  }
  throw new Error(`${label}多次失败：${lastErr}`);
};
const chance = p => Math.random() < p;

let running=false; let randomFail=true;
const hero = document.getElementById('hero'); const cone=document.getElementById('cone'); const door=document.getElementById('door');
const guard=document.getElementById('guard'); const chest=document.getElementById('chest'); const bar=document.getElementById('bar');
const envInfo=document.getElementById('envInfo'); const sky=document.getElementById('sky'); const fog=document.getElementById('fog'); const rain=document.getElementById('rain');

const World = { weather:'clear', timeOfDay:'night', difficulty:'normal' };
const Env = {
  stealthSuccessBase(){
    let base=0.65;
    if(World.timeOfDay==='night') base+=0.15;
    if(World.weather==='rain' || World.weather==='fog') base+=0.1;
    if(World.difficulty==='hard') base-=0.1;
    if(World.difficulty==='easy') base+=0.1;
    if(!randomFail) base=0.98;
    return Math.max(0.1, Math.min(0.98, base));
  },
  riddleSuccessBase(){
    let base=0.75;
    if(World.weather==='fog') base-=0.08;
    if(World.difficulty==='hard') base-=0.1;
    if(World.difficulty==='easy') base+=0.1;
    if(!randomFail) base=0.98;
    return Math.max(0.2, Math.min(0.98, base));
  }
};

// 星星
(function makeStars(){
  const stars = document.getElementById('stars');
  for(let i=0;i<110;i++){
    const s = document.createElement('div'); s.className='star';
    s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*50 + '%';
    s.style.opacity = (0.3 + Math.random()*0.7).toFixed(2);
    s.style.transform = `scale(${0.5 + Math.random()*1.6})`;
    stars.appendChild(s);
  }
})();

function setHeroX(percent){ hero.style.setProperty('--x', percent + '%'); cone.style.left = `calc(${percent}% + 26px)`; }
function sparkBurst(x,y,count=16){
  const stage = document.getElementById('stage');
  for(let i=0;i<count;i++){
    const sp=document.createElement('div'); sp.className='spark';
    const ang=Math.random()*Math.PI*2, dist=6+Math.random()*22;
    sp.style.left = x + 'px'; sp.style.top = y + 'px'; stage.appendChild(sp);
    const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
    sp.animate([{transform:'translate(0,0)', opacity:1},{transform:`translate(${dx}px,${dy}px)`, opacity:0}],{duration:500+Math.random()*300, easing:'ease-out'});
    setTimeout(()=>sp.remove(), 900);
  }
}
function setProgress(v){ bar.style.width = `${Math.round(v*100)}%`; }

// 天气与昼夜
function applyEnvironment(){
  const day = World.timeOfDay==='day';
  sky.style.background = day
    ? 'radial-gradient(600px 300px at 60% -10%, #4b87e6, #2b64b8)'
    : 'radial-gradient(600px 300px at 60% -10%, #1b2a4a, #0d1527)';
  fog.style.opacity = World.weather==='fog' ? 1 : 0;
  rain.style.opacity = World.weather==='rain' ? 1 : 0;
  // 生成雨滴
  if(World.weather==='rain' && rain.childElementCount===0){
    for(let i=0;i<80;i++){
      const d=document.createElement('div'); d.className='drop';
      d.style.left = Math.random()*100 + '%'; d.style.animationDelay = (Math.random()*0.8)+'s';
      rain.appendChild(d);
    }
  }
  envInfo.innerHTML = `
    <span class="pill">天气：${World.weather==='clear'?'晴朗':World.weather==='rain'?'小雨':'薄雾'}</span>
    <span class="pill">时间：${day?'白昼':'夜晚'}</span>
    <span class="pill">难度：${World.difficulty==='easy'?'简单':World.difficulty==='hard'?'困难':'普通'}</span>
  `;
}

// API 实现（页面版）
class TreasureMap {
  static getInitialClue(){ return new Promise(res=>setTimeout(()=>res("在古老的图书馆里找到了第一个线索与半幅残图..."), 800)); }
  static decodeAncientScript(clue){
    return new Promise((res, rej)=>setTimeout(()=>{
      if(!clue) return rej("没有线索可以解码!");
      res("解码成功! 宝藏位于雾林后的古神庙。");
    }, 900));
  }
  static searchTemple(location){
    return new Promise((res, rej)=>setTimeout(()=>{
      if(!location) return rej("没有地点无法搜索神庙!");
      res("在主殿前发现了一个神秘的箱子...");
    }, 900));
  }
  static openTreasureBox(){ return new Promise(res=>setTimeout(()=>res("恭喜! 你打开了传说中的宝箱!"), 800)); }
}
class WorldAPI {
  static getWeatherAndTime(){
    return new Promise(res=>setTimeout(()=>{
      const pool=['clear','rain','fog']; World.weather = pool[Math.floor(Math.random()*pool.length)];
      World.timeOfDay = Math.random()<0.6 ? 'night' : 'day'; applyEnvironment(); res({weather:World.weather, time:World.timeOfDay});
      log(`环境就绪：${World.weather==='clear'?'晴朗':World.weather==='rain'?'小雨':'薄雾'} / ${World.timeOfDay==='night'?'夜晚':'白昼'}`, 'info');
    }, 600));
  }
  static consultHistorian(){ const t=700+Math.random()*500; return new Promise(res=>setTimeout(()=>res("历史学家：避开虬根地面，西北偏北前行。"), t)); }
  static consultCartographer(){ const t=600+Math.random()*700; return new Promise(res=>setTimeout(()=>res("制图学家：根据残图，门楣左三右一按压。"), t)); }
  static solveRiddleDoor(hasHint=false){
    return new Promise((res, rej)=>setTimeout(()=>{
      const base = Env.riddleSuccessBase() + (hasHint?0.12:0);
      if(chance(base)) res("机关门发出沉闷咔哒声，符文依次熄灭。"); else rej("谜题失败：触发了干扰符纹。");
    }, 900));
  }
  static craftSmokeBomb(materials=1){
    return new Promise((res, rej)=>setTimeout(()=>{
      if(materials<=0) return rej("没有材料制作烟雾弹。");
      if(!randomFail || chance(0.85)) res("制作完成：烟雾弹 x1"); else rej("调配失败：火粉比例不对。");
    }, 700));
  }
  static stealthPastGuards(withSmoke=false){
    return new Promise((res, rej)=>setTimeout(()=>{
      const base = Env.stealthSuccessBase() + (withSmoke?0.18:0);
      if(!randomFail || chance(base)) res("成功绕过守卫巡逻。"); else rej("被守卫发现，迫不得已后退。");
    }, 900));
  }
  static choosePath(preferSafe=true){ return new Promise(res=>setTimeout(()=>res(preferSafe?"safe":"risky"), 300)); }
  static async disarmTrapProgressive(onProgress){
    const steps = [
      {name:"识别陷阱结构", t:700, p:!randomFail?1:0.95},
      {name:"拆解齿轮簧片", t:900, p:!randomFail?1:0.85},
      {name:"缓慢拔出毒针", t:1000, p:!randomFail?1:0.8},
    ];
    for(let i=0;i<steps.length;i++){
      const s=steps[i]; await sleep(s.t);
      if(onProgress) onProgress((i+1)/steps.length, s.name);
      if(randomFail && !chance(s.p)) throw new Error(`在步骤“${s.name}”失手！`);
    }
    return "陷阱完全解除。";
  }
  static appraiseTreasure(){ return new Promise(res=>setTimeout(()=>{
    const roll=Math.random(); const msg= roll<0.7?"鉴定：真品！":(roll<0.9?"鉴定：精巧的赝品。":"鉴定：宝物被人调包过。"); res(msg);
  }, 700)); }
  static celebrate(kind){ return new Promise(res=>setTimeout(()=>res(`庆祝：${kind}`), 600)); }
}

// 动画控制
async function moveHeroTo(p){ setHeroX(p); await sleep(600); }
function guardAlertFlash(){
  guard.animate([{filter:'brightness(1)'},{filter:'brightness(1.7)'},{filter:'brightness(1)'}],{duration:500});
}
function pingAt(el){ const r=el.getBoundingClientRect(); sparkBurst(r.x+r.width/2, r.y+r.height/2, 18); }

// 主流程
async function runQuest(){
  if(running) return; running=true; document.getElementById('run').disabled=true; document.getElementById('retry').disabled=true;
  try{
    clearLog(); setProgress(0); hero.classList.remove('sad','happy'); chest.classList.remove('glow'); door.classList.remove('open');
    log("出发！", 'info'); tip("任务开始");

    await WorldAPI.getWeatherAndTime();

    // 并发竞速获取提示
    const fastest = await Promise.race([WorldAPI.consultHistorian(), WorldAPI.consultCartographer()]);
    log(`最快情报：${fastest}`, 'ok');

    await moveHeroTo(18); setProgress(0.08);
    const clue = await TreasureMap.getInitialClue(); log(clue, 'ok');

    await moveHeroTo(30); setProgress(0.16);
    const loc = await retry(()=>TreasureMap.decodeAncientScript(clue), 1, 500, "解码古文"); log(loc, 'ok');

    // 制作烟雾弹（带重试）
    let smoke=false;
    try{
      const craft = await retry(()=>WorldAPI.craftSmokeBomb(1), 1, 400, "制作烟雾弹");
      smoke=true; log(craft, 'ok'); pingAt(hero);
    }catch(e){ log("无烟雾弹，准备硬闯潜行。", 'info'); }

    await moveHeroTo(40); setProgress(0.28);
    log("尝试解开机关门...", 'info');
    try{
      const msg = await WorldAPI.solveRiddleDoor(false); door.classList.add('open'); log(msg, 'ok'); pingAt(door);
    }catch(e){
      log(e.message || e, 'err'); log("使用提示再次尝试...", 'info');
      const msg = await WorldAPI.solveRiddleDoor(true); door.classList.add('open'); log(msg, 'ok'); pingAt(door);
    }

    await moveHeroTo(52); setProgress(0.4);

    // 守卫潜行带超时与重试
    try{
      await withTimeout(retry(()=>WorldAPI.stealthPastGuards(smoke), 1, 700, "潜行"), 4200, "潜行");
      log("成功绕过守卫。", 'ok'); hero.classList.add('happy'); pingAt(guard);
    }catch(e){
      guardAlertFlash(); hero.classList.add('sad'); throw e;
    }

    await moveHeroTo(60); setProgress(0.5);

    // 路线选择
    const preferSafe = document.getElementById('path').value==='safe';
    const path = await WorldAPI.choosePath(preferSafe);
    log(`选择路线：${path==='safe'?'安全路线（绕远）':'捷径（更险）'}`, 'info');
    if(path==='risky'){ World.difficulty = 'hard'; applyEnvironment(); }

    await moveHeroTo(70); setProgress(0.64);

    // 解除陷阱（带进度报告）
    log("开始解除箱子陷阱...", 'info'); let lastStep='';
    const trap = await retry(()=>WorldAPI.disarmTrapProgressive((progress, step)=>{
      lastStep = step; setProgress(0.64 + progress*0.2); log(`进度：${Math.round(progress*100)}% - ${step}`, 'info');
    }), 1, 800, "解除陷阱");
    log(trap, 'ok'); pingAt(chest);

    await moveHeroTo(80); setProgress(0.86);

    const open = await TreasureMap.openTreasureBox(); chest.classList.add('glow'); log(open, 'ok');

    await moveHeroTo(88); setProgress(0.92);

    const appraisal = await WorldAPI.appraiseTreasure(); log(appraisal, appraisal.includes("真品")?'ok':'info');

    const finale = await WorldAPI.celebrate(appraisal.includes("真品") ? "胜利夜宴" : "凯旋总结会");
    log(finale, 'ok'); setProgress(1); tip("任务完成！");
  }catch(err){
    log(`任务失败：${err.message || err}`, 'err'); tip("任务失败");
  }finally{
    running=false; document.getElementById('run').disabled=false; document.getElementById('retry').disabled=false;
  }
}

// 事件绑定
document.getElementById('run').addEventListener('click', ()=>{
  World.difficulty = document.getElementById('difficulty').value;
  applyEnvironment(); runQuest();
});
document.getElementById('retry').addEventListener('click', runQuest);
document.getElementById('toggleRandom').addEventListener('click', (e)=>{
  randomFail = !randomFail; e.target.textContent = randomFail ? "关闭随机失败" : "开启随机失败";
  tip(randomFail ? "已开启随机事件" : "已关闭随机失败（更易成功）");
});
document.getElementById('difficulty').addEventListener('change', (e)=>{ World.difficulty = e.target.value; applyEnvironment(); });
document.getElementById('onlyError').addEventListener('click', (e)=>{
  onlyErr = !onlyErr; e.target.textContent = `仅看错误：${onlyErr?'开':'关'}`; clearLog(); logStore.forEach(i=>{ if(!onlyErr || i.type==='err') log(i.msg, i.type); });
});
document.getElementById('exportLog').addEventListener('click', exportLog);

// 初始化环境
applyEnvironment();
</script>
</body>
</html>